name: B2BTail Suite - Docker Sharded

on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  # Job 1: Build the image (Optional but ensures consistency)
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t b2btail-playwright .

  # Job 2: Run Shards in Parallel
  docker-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2] # Adjust this if you want more parallel runners
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t b2btail-playwright .

      - name: Run Playwright Shard ${{ matrix.shard }}
        run: |
          docker run --name test-shard-${{ matrix.shard }} \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            -v ${{ github.workspace }}/blob-report:/app/blob-report \
            b2btail-playwright \
            npx playwright test --shard=${{ matrix.shard }}/2 --reporter=blob,allure-playwright

      - name: Upload Shard Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-results-shard-${{ matrix.shard }}
          path: |
            blob-report/
            allure-results/
          retention-days: 1

  # Job 3: Merge, Generate Reports, and Publish to Pages
  merge-reports:
    if: always()
    needs: [docker-test]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for peaceiris/actions-gh-pages
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Download all shard artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: all-results-shard-*
          path: merged-results
          merge-multiple: true

      - name: Merge Playwright Reports
        run: |
          npx playwright merge-reports ./merged-results/blob-report --reporter=json > results.json
          npx playwright merge-reports ./merged-results/blob-report --reporter=html
        env:
          PLAYWRIGHT_HTML_OPEN: never

      - name: Generate Allure Report
        run: |
          npx allure generate ./merged-results/allure-results --clean -o allure-report

      # --- CONSOLIDATED PUBLISHING LOGIC ---
      - name: Prepare reports for deployment
        if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch'
        run: |
          mkdir -p public-reports
          cp -r playwright-report public-reports/
          cp -r allure-report public-reports/

      - name: Publish Reports to GitHub Pages
        if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public-reports
          publish_branch: gh-pages

      - name: Show report URLs in summary
        if: always()
        run: |
          OWNER=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)
          REPO=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          PLAYWRIGHT_URL="https://$OWNER.github.io/$REPO/playwright-report/"
          ALLURE_URL="https://$OWNER.github.io/$REPO/allure-report/"
          
          echo "### ðŸš€ Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "The latest reports have been generated and deployed:" >> $GITHUB_STEP_SUMMARY
          echo "* ðŸŽ­ **Playwright:** [$PLAYWRIGHT_URL]($PLAYWRIGHT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "* ðŸ“Š **Allure:** [$ALLURE_URL]($ALLURE_URL)" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "results.json" ]; then
            PASSED=$(jq '.stats.expected' results.json || echo "0")
            FAILED=$(jq '.stats.unexpected' results.json || echo "0")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Quick Stats:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
          fi